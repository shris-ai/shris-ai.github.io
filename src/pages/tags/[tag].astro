---
import Layout from '../../layouts/Layout.astro';
import TopBar from '../../components/TopBar.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getCollection } from 'astro:content';
import { getTagColorCSS } from '../../utils/tagColors.ts';
import '../../styles/page-tags.css';

export async function getStaticPaths() {
  const papers = await getCollection('papers');
  const tagSet = new Set<string>();
  papers.forEach((e) => (e.data.tags || []).forEach((t: string) => tagSet.add(t)));
  const tags = Array.from(tagSet).sort();
  return tags.map((tagDisplay) => ({
    params: { tag: tagDisplay.toLowerCase().replace(/\s+/g, '-') },
    props: { tagDisplay },
  }));
}

const { tag } = Astro.params;
const tagDisplay = Astro.props.tagDisplay || (tag || '').replace(/-/g, ' ');
const allPapers = await getCollection('papers');
const tagNorm = (tagDisplay || tag || '').toLowerCase().replace(/\s+/g, '-');
const papers = allPapers.filter((e) =>
  (e.data.tags || []).some((t: string) => t.toLowerCase().replace(/\s+/g, '-') === tagNorm || t.toLowerCase() === (tagDisplay || tag || '').toLowerCase())
);

const title = `Papers tagged "${tagDisplay || tag}"`;
const description = `Explore AI research papers tagged with ${tagDisplay || tag}. Deep dives into machine learning, NLP, and more.`;
---

<Layout
  title={`${title} - Shristi Gautam`}
  description={description}
  ogImage="/assets/bio-image.jpg"
>
  <TopBar />
  <Breadcrumb items={[
    { label: 'Home', href: '/' },
    { label: 'Paper Dive-Ins', href: '/paper-dive-ins' },
    { label: tagDisplay || tag || 'Tag' }
  ]} />
  <div class="page-container page-tags-container">
    <h1 class="page-title page-tags-title app-struct">{title}</h1>
    <p class="page-tags-description">
      {papers.length} {papers.length === 1 ? 'paper' : 'papers'} tagged with
      <strong>{tagDisplay || tag}</strong>
    </p>
    <div class="paper-list-grid page-tags-list-grid app-struct">
      {papers.map((entry) => (
        <div key={entry.slug}>
          <a href={`/paper-breakdown/${entry.slug}`} class="page-tags-card-link">
            <article class="page-tags-card-content">
              <h2 class="paper-card-title paper-card-title--small">{entry.data.title}</h2>
              <div class="page-tags-tags-row">
                {(entry.data.tags || []).map((t: string) => {
                  const colorCSS = getTagColorCSS(t);
                  return (
                    <span key={t} class="shared-tag-chip" style={colorCSS}>{t}</span>
                  );
                })}
              </div>
              {entry.data.description && (
                <p class="paper-card-description paper-card-description--small">{entry.data.description}</p>
              )}
            </article>
          </a>
        </div>
      ))}
    </div>
    <p class="page-tags-back-link">
      <a href="/paper-dive-ins">‚Üê Back to all papers</a>
    </p>
  </div>
</Layout>
