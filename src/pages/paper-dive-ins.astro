---
import Layout from '../layouts/Layout.astro';
import TopBar from '../components/TopBar.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import papers from '../data/papers.ts';
import { getAllTags, parseDateForFilter } from '../utils/papers.ts';
import { getTagColorCSS } from '../utils/tagColors.ts';
import '../styles/page-paper-dive-ins.css';

const title = "Deep Dives into AI Research";
const description = "Explore various research papers and their implications in the field of AI and machine learning.";
const allTags = getAllTags();

// CollectionPage Schema for SEO
const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": title,
  "description": description,
  "url": "https://shris-ai.github.io/paper-dive-ins",
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": papers.map((paper, index) => {
      const slug = paper.title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      return {
        "@type": "ListItem",
        "position": index + 1,
        "item": {
          "@type": "Article",
          "name": paper.title,
          "description": paper.description,
          "url": `https://shris-ai.github.io/paper-breakdown/${slug}`
        }
      };
    })
  }
};
---

<Layout title={`${title} - Shristi Gautam`} description={description} ogImage="/assets/bio-image.jpg">
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
  <TopBar />
  <Breadcrumb items={[
    { label: 'Home', href: '/' },
    { label: 'Paper Dive-Ins' }
  ]} />
  <div class="page-container page-dive-ins-container">
    <header class="page-dive-ins-heading-block app-struct">
      <h1 class="page-dive-ins-heading-title">{title}</h1>
      <p class="page-dive-ins-intro">
        I go deep on AI research in the areas I work in—to stay updated and to build a notes library I can revisit. I often use LLMs for quick prototyping and to get up to speed fast; then I go further on my own. 
      </p>
    </header>
    <div class="page-dive-ins-filter-wrap">
      <div class="page-dive-ins-filter-row">
        <button 
          type="button"
          class="page-dive-ins-filter-trigger" 
          id="filter-trigger"
          aria-label="Open filters"
          aria-expanded="false"
          aria-haspopup="true"
          title="Filters"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          <span class="page-dive-ins-filter-badge" id="filter-badge" style="display: none;">0</span>
        </button>
        {allTags.length > 0 && (
          <div class="page-dive-ins-tags-inline">
            {allTags.map((tag) => {
              const colorCSS = getTagColorCSS(tag);
              return (
                <button type="button" class="shared-tag-pill page-dive-ins-filter-tag" data-tag={tag} aria-pressed="false" style={colorCSS}>{tag}</button>
              );
            })}
          </div>
        )}
      </div>
      <div class="page-dive-ins-filter-panel" id="filter-panel" aria-hidden="true">
        <div class="page-dive-ins-filter-panel-inner">
          <div class="page-dive-ins-filter-panel-header">
            <h2 class="page-dive-ins-filter-panel-title">Filters</h2>
            <button type="button" class="page-dive-ins-filter-panel-close" id="filter-panel-close" aria-label="Close filters">×</button>
          </div>
          <div class="page-dive-ins-filter-section">
            <span class="page-dive-ins-filter-label">Tags</span>
            <button type="button" class="page-dive-ins-remove-tags-btn" id="remove-tags-btn" style="display: none;">Remove filter</button>
          </div>
          <div class="page-dive-ins-filter-section">
            <span class="page-dive-ins-filter-label">Published date</span>
            <div class="page-dive-ins-date-range">
              <label class="page-dive-ins-date-label">
                <span>From</span>
                <input type="date" id="filter-published-from" class="page-dive-ins-date-input" />
              </label>
              <label class="page-dive-ins-date-label">
                <span>To</span>
                <input type="date" id="filter-published-to" class="page-dive-ins-date-input" />
              </label>
            </div>
          </div>
          <div class="page-dive-ins-filter-section">
            <span class="page-dive-ins-filter-label">Review date</span>
            <div class="page-dive-ins-date-range">
              <label class="page-dive-ins-date-label">
                <span>From</span>
                <input type="date" id="filter-reviewed-from" class="page-dive-ins-date-input" />
              </label>
              <label class="page-dive-ins-date-label">
                <span>To</span>
                <input type="date" id="filter-reviewed-to" class="page-dive-ins-date-input" />
              </label>
            </div>
          </div>
          <div class="page-dive-ins-filter-panel-actions">
            <button type="button" class="page-dive-ins-filter-clear-btn" id="filter-clear-btn">Clear all</button>
          </div>
        </div>
      </div>
    </div>
    <div class="paper-list-grid page-dive-ins-list-grid" id="paper-list">
      {papers.map((paper) => {
        const slug = paper.title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const paperTags = paper.tags.join(',').toLowerCase();
        return (
        <article key={paper.title.replace(" ", "")} class="page-dive-ins-paper-item page-dive-ins-card app-struct" data-tags={paperTags} data-published-iso={parseDateForFilter(paper.publishedDate || '') || ''} data-reviewed-iso={parseDateForFilter(paper.reviewedDate || '') || ''}>
          <a href={`/paper-breakdown/${slug}`} class="page-dive-ins-card-link">
            <h2 class="page-dive-ins-card-title">{paper.title}</h2>
          </a>
          <div class="page-dive-ins-card-meta">
            {paper.tags.map((tag) => {
              const colorCSS = getTagColorCSS(tag);
              return (
                <span key={tag} class="shared-tag-chip" style={colorCSS}>{tag}</span>
              );
            })}
          </div>
          <dl class="page-dive-ins-card-details">
            {paper.publishedDate && (
              <div class="page-dive-ins-card-detail">
                <dt>Published</dt>
                <dd>{paper.publishedDate}</dd>
              </div>
            )}
            {paper.sourceUrl && (
              <div class="page-dive-ins-card-detail">
                <dt>Source</dt>
                <dd>
                  <a href={paper.sourceUrl} target="_blank" rel="noopener noreferrer" class="page-dive-ins-source-link">
                    {paper.sourceLabel || 'Link'}
                  </a>
                </dd>
              </div>
            )}
            {paper.reviewedDate && (
              <div class="page-dive-ins-card-detail">
                <dt>Reviewed</dt>
                <dd>{paper.reviewedDate}</dd>
              </div>
            )}
            {paper.status && (
              <div class="page-dive-ins-card-detail">
                <dt>Status</dt>
                <dd><span class="page-dive-ins-status">{paper.status}</span></dd>
              </div>
            )}
          </dl>
        </article>
        );
      })}
    </div>
    <div class="page-dive-ins-no-results" id="no-results" style="display: none;">
      <p>No papers match the selected filters. <button type="button" class="page-dive-ins-clear-link" id="clear-filters-link">Clear filters</button></p>
    </div>
  </div>
</Layout>

<script is:inline>
  (function() {
    const filterTrigger = document.getElementById('filter-trigger');
    const filterPanel = document.getElementById('filter-panel');
    const filterPanelClose = document.getElementById('filter-panel-close');
    const filterClearBtn = document.getElementById('filter-clear-btn');
    const removeTagsBtn = document.getElementById('remove-tags-btn');
    const filterBadge = document.getElementById('filter-badge');
    const filterTags = document.querySelectorAll('.page-dive-ins-filter-tag');
    const publishedFrom = document.getElementById('filter-published-from');
    const publishedTo = document.getElementById('filter-published-to');
    const reviewedFrom = document.getElementById('filter-reviewed-from');
    const reviewedTo = document.getElementById('filter-reviewed-to');
    const paperItems = document.querySelectorAll('.page-dive-ins-paper-item');
    const clearFiltersLink = document.getElementById('clear-filters-link');
    const noResults = document.getElementById('no-results');
    const paperList = document.getElementById('paper-list');

    const selectedTags = new Set();

    function hasAnyFilter() {
      const hasTag = selectedTags.size > 0;
      const hasPublished = (publishedFrom?.value) || (publishedTo?.value);
      const hasReviewed = (reviewedFrom?.value) || (reviewedTo?.value);
      return hasTag || hasPublished || hasReviewed;
    }

    function countActiveFilters() {
      let n = selectedTags.size;
      if (publishedFrom?.value) n++;
      if (publishedTo?.value) n++;
      if (reviewedFrom?.value) n++;
      if (reviewedTo?.value) n++;
      return n;
    }

    function updateFilters() {
      filterTags.forEach((btn) => {
        const tag = btn.dataset.tag?.toLowerCase() || '';
        const isSelected = selectedTags.has(tag);
        btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
        btn.classList.toggle('page-dive-ins-filter-tag--active', isSelected);
      });

      const count = countActiveFilters();
      if (filterBadge) {
        if (count > 0) {
          filterBadge.style.display = 'flex';
          filterBadge.textContent = count > 99 ? '99+' : String(count);
        } else {
          filterBadge.style.display = 'none';
        }
      }

      const pubFrom = publishedFrom?.value || '';
      const pubTo = publishedTo?.value || '';
      const revFrom = reviewedFrom?.value || '';
      const revTo = reviewedTo?.value || '';

      let visibleCount = 0;
      paperItems.forEach((item) => {
        const paperTagsStr = (item.dataset.tags || '').toLowerCase();
        const paperTags = paperTagsStr.split(',').map(t => t.trim());
        const paperPub = (item.dataset.publishedIso || '').trim();
        const paperRev = (item.dataset.reviewedIso || '').trim();

        const matchTags = selectedTags.size === 0 || Array.from(selectedTags).some(tag => paperTags.includes(tag.toLowerCase()));
        const matchPublished = (!pubFrom && !pubTo) || (
          (!pubFrom || (paperPub && paperPub >= pubFrom)) &&
          (!pubTo || (paperPub && paperPub <= pubTo))
        );
        const matchReviewed = (!revFrom && !revTo) || (
          (!revFrom || (paperRev && paperRev >= revFrom)) &&
          (!revTo || (paperRev && paperRev <= revTo))
        );

        if (matchTags && matchPublished && matchReviewed) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      if (noResults && paperList) {
        if (visibleCount === 0 && hasAnyFilter()) {
          noResults.style.display = 'block';
          paperList.style.display = 'none';
        } else {
          noResults.style.display = 'none';
          paperList.style.display = '';
        }
      }

      if (removeTagsBtn) {
        removeTagsBtn.style.display = selectedTags.size > 0 ? 'inline-block' : 'none';
      }
    }

    function openPanel() {
      filterPanel?.classList.add('page-dive-ins-filter-panel--open');
      filterTrigger?.setAttribute('aria-expanded', 'true');
      filterPanel?.setAttribute('aria-hidden', 'false');
    }

    function closePanel() {
      filterPanel?.classList.remove('page-dive-ins-filter-panel--open');
      filterTrigger?.setAttribute('aria-expanded', 'false');
      filterPanel?.setAttribute('aria-hidden', 'true');
    }

    function clearFilters() {
      selectedTags.clear();
      if (publishedFrom) publishedFrom.value = '';
      if (publishedTo) publishedTo.value = '';
      if (reviewedFrom) reviewedFrom.value = '';
      if (reviewedTo) reviewedTo.value = '';
      updateFilters();
    }

    filterTrigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (filterPanel?.classList.contains('page-dive-ins-filter-panel--open')) closePanel();
      else openPanel();
    });
    filterPanelClose?.addEventListener('click', closePanel);
    filterClearBtn?.addEventListener('click', clearFilters);
    removeTagsBtn?.addEventListener('click', () => {
      selectedTags.clear();
      updateFilters();
    });
    if (clearFiltersLink) clearFiltersLink.addEventListener('click', clearFilters);

    filterTags.forEach((btn) => {
      btn.addEventListener('click', () => {
        const tag = (btn.dataset.tag || '').toLowerCase().trim();
        if (tag && selectedTags.has(tag)) selectedTags.delete(tag);
        else if (tag) selectedTags.add(tag);
        updateFilters();
      });
    });

    [publishedFrom, publishedTo, reviewedFrom, reviewedTo].forEach((el) => {
      el?.addEventListener('change', updateFilters);
      el?.addEventListener('input', updateFilters);
    });

    var dateInputs = [publishedFrom, publishedTo, reviewedFrom, reviewedTo];
    document.addEventListener('click', function(e) {
      if (!filterPanel || !filterPanel.classList.contains('page-dive-ins-filter-panel--open')) return;
      if (filterPanel.contains(e.target) || (filterTrigger && filterTrigger.contains(e.target))) return;
      var active = document.activeElement;
      var activeIsDateInput = dateInputs.some(function(el) { return el && active === el; });
      if (activeIsDateInput) return;
      closePanel();
    });

    updateFilters();
  })();
</script>
