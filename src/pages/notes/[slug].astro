---
import Layout from '../../layouts/Layout.astro';
import TopBar from '../../components/TopBar.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getCollection, render } from 'astro:content';
import { getCoverImageUrl } from '../../utils/coverImage.ts';
import { getTagColorCSS } from '../../utils/tagColors.ts';
import { parseDateToISO } from '../../utils/papers.ts';
import '../../styles/page-paper-breakdown.css';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  return notes.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { slug } = Astro.params;
const entry = Astro.props.entry;
if (!entry) {
  return Astro.redirect('/notes');
}
const { Content, headings } = await render(entry);
const toc = headings.map((h) => ({ id: h.slug, text: h.text, level: h.depth }));
const wordCount = (entry.body || '').trim().split(/\s+/).filter(Boolean).length;
const readingTimeMinutes = Math.max(1, Math.ceil(wordCount / 200));

const siteURL = 'https://shris-ai.github.io';
const ogImage = `${siteURL}${getCoverImageUrl('notes', entry.slug)}`;

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: entry.data.title,
  description: entry.data.description,
  image: ogImage,
  author: {
    '@type': 'Person',
    name: 'Shristi Gautam',
    url: siteURL,
    sameAs: ['https://www.linkedin.com/in/shristigautam/', 'https://github.com/shris-ai'],
  },
  publisher: { '@type': 'Person', name: 'Shristi Gautam', url: siteURL },
  datePublished: parseDateToISO(entry.data.publishedDate) || new Date().toISOString(),
  dateModified: parseDateToISO(entry.data.publishedDate) || new Date().toISOString(),
  timeRequired: `PT${readingTimeMinutes}M`,
  mainEntityOfPage: { '@type': 'WebPage', '@id': `${siteURL}/notes/${entry.slug}` },
  keywords: (entry.data.tags || []).join(', '),
  articleSection: 'Blog',
  inLanguage: 'en',
};

const publishedTime = parseDateToISO(entry.data.publishedDate) || new Date().toISOString();
---

<Layout
  title={`${entry.data.title} - Shristi Gautam`}
  description={entry.data.description}
  type="article"
  publishedTime={publishedTime}
  author="Shristi Gautam"
  tags={entry.data.tags ?? []}
  ogImage={ogImage}
  ogImageAlt={entry.data.title}
  stackEdit={true}
>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <TopBar />
  <Breadcrumb
    items={[
      { label: 'Home', href: '/' },
      { label: 'Blog', href: '/notes' },
      { label: entry.data.title },
    ]}
  />
  <div class="page-container page-breakdown-container">
    <div class="page-breakdown-title-meta app-struct">
      <h1 class="page-title page-title--no-top-margin">{entry.data.title}</h1>
      <div class="page-breakdown-meta-row">
        <span class="page-breakdown-reading-time" aria-label="Estimated reading time">
          {readingTimeMinutes} min read
        </span>
        {entry.data.tags?.length ? (
          <span class="page-breakdown-tags-inline">
            {entry.data.tags.map((tag: string) => {
              const tagSlug = tag.toLowerCase().replace(/\s+/g, '-');
              const colorCSS = getTagColorCSS(tag);
              return (
                <a href={`/tags/${tagSlug}`} class="shared-tag-link" style={colorCSS}>
                  {tag}
                </a>
              );
            })}
          </span>
        ) : null}
      </div>
      {entry.data.publishedDate ? (
        <dl class="page-breakdown-meta-details">
          <div class="page-breakdown-meta-detail">
            <dt>Published</dt>
            <dd>{entry.data.publishedDate}</dd>
          </div>
        </dl>
      ) : null}
    </div>
    {toc.length > 0 ? (
      <nav class="page-breakdown-toc-mobile" aria-label="Table of contents">
        <h2 class="page-breakdown-toc-title">On this page</h2>
        <ul class="page-breakdown-toc-list">
          {toc.map((entry) => (
            <li class={`page-breakdown-toc-item page-breakdown-toc-level-${entry.level}`}>
              <a href={`#${entry.id}`}>{entry.text}</a>
            </li>
          ))}
        </ul>
      </nav>
    ) : null}
    <div class="page-breakdown-content-wrapper app-struct" id="content-wrapper">
      {toc.length > 0 ? (
        <nav class="page-breakdown-toc-sidebar" id="toc-sidebar" aria-label="Table of contents">
          <div class="page-breakdown-toc-header">
            <h2 class="page-breakdown-toc-title">On this page</h2>
            <button class="page-breakdown-toc-close" id="toc-close" aria-label="Close table of contents">
              Ã—
            </button>
          </div>
          <ul class="page-breakdown-toc-list">
            {toc.map((entry) => (
              <li class={`page-breakdown-toc-item page-breakdown-toc-level-${entry.level}`}>
                <a href={`#${entry.id}`}>{entry.text}</a>
              </li>
            ))}
          </ul>
        </nav>
      ) : null}
      <div class="page-breakdown-markdown">
        {toc.length > 0 ? (
          <button
            class="page-breakdown-toc-toggle"
            id="toc-toggle"
            aria-label="Toggle table of contents"
            aria-expanded="false"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
        ) : null}
        <Content />
      </div>
    </div>
    <AuthorBio />
  </div>
</Layout>

<script is:inline>
  (function() {
    const tocToggle = document.getElementById('toc-toggle');
    const tocSidebar = document.getElementById('toc-sidebar');
    const tocClose = document.getElementById('toc-close');
    const contentWrapper = document.getElementById('content-wrapper');
    const SIDEBAR_ACTIVE = 'page-breakdown-toc-sidebar--active';
    const WRAPPER_OPEN = 'page-breakdown-content-wrapper--sidebar-open';

    function openTOC() {
      if (tocSidebar) tocSidebar.classList.add(SIDEBAR_ACTIVE);
      if (contentWrapper) contentWrapper.classList.add(WRAPPER_OPEN);
      if (tocToggle) tocToggle.setAttribute('aria-expanded', 'true');
    }

    function closeTOC() {
      if (tocSidebar) tocSidebar.classList.remove(SIDEBAR_ACTIVE);
      if (contentWrapper) contentWrapper.classList.remove(WRAPPER_OPEN);
      if (tocToggle) tocToggle.setAttribute('aria-expanded', 'false');
    }

    if (tocToggle) tocToggle.addEventListener('click', openTOC);
    if (tocClose) tocClose.addEventListener('click', closeTOC);

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && tocSidebar && tocSidebar.classList.contains(SIDEBAR_ACTIVE)) closeTOC();
    });

    document.querySelectorAll('.page-breakdown-toc-sidebar .page-breakdown-toc-item a').forEach(function(link) {
      link.addEventListener('click', function() { setTimeout(closeTOC, 100); });
    });
  })();
</script>
